import 'dotenv/config';
import { createClient } from '@supabase/supabase-js';

const url = process.env.SUPABASE_URL;
const key = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!url || !key) {
  console.error('Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY');
  process.exit(1);
}

const client = createClient(url, key, { auth: { persistSession: false } });

// Extracted full text from currumbin-original-grounds.md and currumbin-followup-grounds.md
const FULL_TEXT_BACKFILL = [
  {
    key: 'strategic_framework_non_compliance',
    track: 'comprehensive',
    summary: 'The development contradicts the Gold Coast City Plan\'s Natural Landscape Area designation and threatens greenspace networks.',
    full_text: `The proposed development directly contradicts the intent of the **Gold Coast City Plan**, which designates the area as part of the **Natural Landscape Area**. Specifically:

- **Intrusion on Natural Landscape**: The development encroaches on the rural landscape, violating the goals outlined in **Strategic Framework Map 2 -- Settlement Pattern** and undermining efforts to preserve the hinterland core habitat.

- **Impact on Greenspace and Habitat Areas**: The proposed development conflicts with **Strategic Framework Map 4**, which identifies the area as part of the **greenspace network**. This network is critical for maintaining local wildlife habitats and corridors, including for birds and koalas. The introduction of urban-type facilities like this school threatens these habitats.`
  },
  {
    key: 'rural_zone_code_non_compliance',
    track: 'comprehensive',
    summary: 'The intensity and scale are inconsistent with Rural Zone intent and violate key City Plan sections.',
    full_text: `The proposed development's **intensity**, **scale**, and **traffic generation** are inconsistent with the intended land use in the Rural Zone. The project would lead to a detrimental change in the area's character and quality of life, violating key sections of the City Plan, including:

- **Part 3, Section 3.7.2.1(1) and (3)** -- Non-compliance with provisions aimed at protecting natural landscapes.

- **Part 3, Section 3.7.3.1(6) and (10)** -- Impact on the greenspace network and landscape character.

- **Rural Zone Code Sections 6.2.20.2(2)(a)(i)-(v) and 6.2.20.2(2)(b)(i)** -- The proposed facility introduces an urban-scale development that is at odds with the area's rural intent.

The **scale and form** of this educational facility are inappropriate for the rural landscape, as the area is intended for low-impact, rural land uses, not urban infrastructure.`
  },
  {
    key: 'seqrp_non_compliance',
    track: 'comprehensive',
    summary: 'The site falls within the RLRPA which aims to protect rural values from urban encroachment.',
    full_text: `**Protection of Rural Values**

The site falls within the **Regional Landscape and Rural Production Area (RLRPA)** under the SEQRP, which aims to protect rural values from urban encroachment. The proposed educational facility introduces infrastructure that is incompatible with the rural character of the RLRPA.

**Inappropriate Urban Development**

The **SEQRP** specifically restricts inappropriate urban development in the RLRPA. The applicant's assertion that an education facility is an acceptable land use is flawed. While the applicant claims that the school will support the rural community, there is no **substantive evidence** of community demand for this facility in the immediate rural area. Most prospective students are expected to come from urban areas, which undermines the purpose of the RLRPA to maintain the rural landscape and prevent urban sprawl.`
  },
  {
    key: 'traffic_and_parking_issues',
    track: 'comprehensive',
    summary: 'Inadequate infrastructure cannot support additional traffic, with insufficient parking and dangerous access points.',
    full_text: `**Insufficient Infrastructure**

The proposed infrastructure is inadequate to support the development:

- **Diverge/Deceleration Lane**: The current road infrastructure cannot support the additional traffic generated by the development. Insufficient sightlines and road width make the necessary diverge lane unfeasible, creating potential traffic hazards.

- **Car Parking**: The applicant's proposed parking arrangements do not meet the required capacity. With only 13 spaces for 25 staff, this violates the **GCCC Transport Code 2016 (PO25/AO25.1, Condition 9.4.13-3)**. The **use of overflow parking on grassed, steep areas** is both unsafe and fails to meet basic accessibility standards.

- **Bus Service**: The applicant's response provides vague details about the proposed bus service. Two small buses are insufficient to significantly reduce car traffic, and there are no clear operational commitments to support regular use.

- **Bicycle Parking**: The plans do not provide for **Security Level B** bicycle parking, as required by **Australian Standards AS2890.3.2015**. Additionally, there are no **end-of-trip facilities** provided, which are essential for an educational facility under the **Transport Code**.

**Traffic Intensity**

The school will generate substantial traffic beyond daily student transport, including:

- Service and maintenance vehicles, which will contribute to **congestion and safety concerns** on narrow rural roads.

- Special event traffic, which has not been adequately accounted for in the applicant's traffic assessments, leading to **further strain on local infrastructure**.`
  },
  {
    key: 'bulk_excavation_and_earthworks',
    track: 'comprehensive',
    summary: 'Extensive earthworks with steep batters and retaining walls will cause significant construction and visual impacts.',
    full_text: `The design requires approximately **12,600 m³ of cut, 2,400 m³ of fill, and 7,000 m³ of soil to be exported off-site**, with steep batters as tight as 1:1 and extensive retaining walls. This scale of earthworks significantly increases construction impacts, truck movements, and long-term visual scarring of the rural landscape.

To facilitate access, additional vegetation clearance is proposed, including the removal of significant trees. This not only undermines the ecological integrity of the site but also conflicts with the community's expectation that rural landscape character and biodiversity values be preserved. Council has previously indicated that retaining structures within the public road reserve are not supported, yet the application relies heavily on such works.

The combination of easement extension, large-scale excavation, steep batters, retaining walls, and vegetation removal substantially increases the development's visual bulk and undermines the rural amenity of Currumbin Valley.`
  },
  {
    key: 'amenity_and_environmental_concerns',
    track: 'comprehensive',
    summary: 'Noise pollution, visual intrusion, ecological disruption, water quality impacts, and bushfire risks.',
    full_text: `**Noise and Visual Impact**

- **Noise Pollution**: Despite the applicant's updated **Noise Impact Assessment**, significant concerns remain about the **constant noise levels** from buses, car doors, and school activities, which will disrupt the tranquillity of the rural area. The **acoustic management measures** are inadequate, particularly for event days and peak drop-off/pick-up times.

- **Visual Intrusion**: The development's scale and form, along with insufficient **vegetative screening**, will detract from the natural rural landscape, causing visual pollution.

**Environmental Impact**

- **Ecological Disruption**: The proposed development impacts an area of significant vegetation and threatens local biodiversity. The **Arborist report** submitted by the applicant fails to sufficiently address these environmental concerns, and the removal of trees, even if limited, compromises the ecological integrity of the site.

- **Water Quality**: The development will increase **runoff and pollution**, which may harm local water bodies and groundwater, both of which are critical for drinking and irrigation purposes.

- **Bushfire Risk**: The development increases the risk of bushfires in a high-risk rural area, complicating emergency management and endangering personal safety and property.`
  },
  {
    key: 'community_needs_and_infrastructure',
    track: 'comprehensive',
    summary: 'No demonstrated need for a school in this rural setting, with concerns about extended hours and inadequate planning.',
    full_text: `**Lack of Demonstrated Need**

The applicant has not demonstrated a legitimate need for a school in this rural setting. The **majority of prospective students** are likely to come from urban and suburban areas, further contradicting the intent of the RLRPA, which is to preserve rural land for appropriate rural uses.

**Operational Concerns**

- **Extended Hours**: The applicant acknowledges **extended hours for after-school care**, but this will result in increased noise and traffic, disturbing the local community.

- **Lighting and Security**: The **lack of detailed lighting and security plans** poses concerns for adjacent residents, particularly with regard to light pollution and safety during off-hours.

- **Inadequate Access**: The proposed driveway sealing is insufficient for the expected increase in traffic, and long-term maintenance concerns have not been adequately addressed.`
  },
  // Follow-up submission concerns
  {
    key: 'traffic_safety',
    track: 'followup',
    summary: 'Relocated ingress/egress remains dangerous with inadequate sight distances.',
    full_text: `The applicant has relocated the site's ingress/egress to another section of Currumbin Creek Road that remains dangerous. Sight distances are claimed to meet Austroads standards only by undertaking substantial verge reprofiling, battering, and retaining works. The presence of an Armco barrier along this section demonstrates Council's own recognition of road safety risks. This change does not resolve the community's concerns about traffic hazards and instead creates new issues for public road safety.`
  },
  {
    key: 'easement_extension',
    track: 'followup',
    summary: 'Proposal extends easement beyond original scope, altering land tenure arrangements.',
    full_text: `The applicant proposes not only to use an existing easement for access but also to **extend the easement** to facilitate turning movements and traffic flows. This materially alters the land tenure arrangements and extends the development footprint in a way that was not previously notified to the community.`
  },
  {
    key: 'bulk_excavation',
    track: null,  // Visible to all tracks
    summary: 'Approximately 12,600 m³ of cut with steep batters and extensive retaining walls.',
    full_text: `The revised design requires approximately **12,600 m³ of cut, 2,400 m³ of fill, and 7,000 m³ of soil to be exported off-site**, with steep batters as tight as 1:1 and extensive retaining walls. This scale of earthworks far exceeds what was originally presented, significantly increasing construction impacts, truck movements, and long-term visual scarring of the rural landscape.`
  },
  {
    key: 'vegetation_removal',
    track: 'followup',
    summary: 'Additional vegetation clearance undermines ecological integrity and rural character.',
    full_text: `To facilitate the revised access, additional vegetation clearance is proposed, including the removal of significant trees. This not only undermines the ecological integrity of the site but also conflicts with the community's expectation that rural landscape character and biodiversity values be preserved. Council has previously indicated that retaining structures within the public road reserve are not supported, yet the changed application relies heavily on such works.`
  },
  {
    key: 'visual_amenity',
    track: 'followup',
    summary: 'Combined impacts of excavation, easement extension, and vegetation removal undermine rural amenity.',
    full_text: `The combination of easement extension, large-scale excavation, steep batters, retaining walls, and vegetation removal substantially increases the development's visual bulk and undermines the rural amenity of Currumbin Valley.`
  }
];

async function main() {
  console.log('\n🔄 Backfilling full_text for Currumbin concerns...\n');

  let updated = 0;
  let failed = 0;

  for (const concern of FULL_TEXT_BACKFILL) {
    try {
      const { data, error } = await client
        .from('concern_templates')
        .update({
          body: concern.summary,  // Update summary to be clearer
          full_text: concern.full_text  // Add comprehensive full text
        })
        .eq('key', concern.key)
        .eq('version', 'v1')
        .select();

      if (error) {
        console.error(`❌ Failed to update ${concern.key}:`, error.message);
        failed++;
      } else if (data && data.length > 0) {
        console.log(`✅ Updated ${concern.key}`);
        console.log(`   Summary length: ${concern.summary.length} chars`);
        console.log(`   Full text length: ${concern.full_text.length} chars`);
        console.log(`   Track: ${concern.track || 'all'}`);
        updated++;
      } else {
        console.log(`⚠️  No matching concern found for ${concern.key}`);
      }
    } catch (err) {
      console.error(`❌ Error updating ${concern.key}:`, err.message);
      failed++;
    }
  }

  console.log('\n' + '='.repeat(60));
  console.log(`✅ Successfully updated: ${updated} concerns`);
  console.log(`❌ Failed: ${failed} concerns`);
  console.log('='.repeat(60));

  // Verification query
  console.log('\n📊 Verification: Checking database state...\n');
  const { data: allConcerns, error: checkError } = await client
    .from('concern_templates')
    .select('key, track, body, full_text')
    .eq('version', 'v1')
    .eq('is_active', true);

  if (checkError) {
    console.error('Error checking database:', checkError.message);
  } else {
    const withFullText = allConcerns.filter(c => c.full_text && c.full_text.length > 0);
    const withMeasurements = allConcerns.filter(c => 
      (c.full_text || c.body).includes('12,600')
    );

    console.log(`Total active v1 concerns: ${allConcerns.length}`);
    console.log(`Concerns with full_text populated: ${withFullText.length}`);
    console.log(`Concerns with bulk excavation measurements: ${withMeasurements.length}`);
    
    console.log('\nConcerns with full_text:');
    withFullText.forEach(c => {
      console.log(`  - ${c.key} (${c.full_text.length} chars, track: ${c.track || 'all'})`);
    });
  }

  console.log('\n✨ Backfill complete! Ready for AI generation with comprehensive data.\n');
}

main().catch((e) => {
  console.error('Fatal error:', e);
  process.exit(1);
});

